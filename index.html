<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Vendor Central Shipment Upload Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #232f3e 0%, #37475a 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .step {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .warehouse-selection {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .warehouse-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }
        
        .warehouse-option:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        .warehouse-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .warehouse-option h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .warehouse-option p {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .date-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .date-input-group label {
            font-weight: 500;
            color: #495057;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }
        
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            margin-top: 10px;
        }
        
        .file-upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .file-upload-area.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-upload-area.file-loaded {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-icon {
            font-size: 36px;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .upload-text {
            font-size: 14px;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .upload-subtext {
            font-size: 12px;
            color: #6c757d;
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 13px;
        }
        
        .file-size {
            color: #6c757d;
            font-size: 11px;
        }
        
        .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .remove-file:hover {
            background: #c82333;
        }
        
        .process-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .process-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .process-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .processing {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .success-message {
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #155724;
        }
        
        .error-section, .warning-section {
            margin-bottom: 20px;
        }
        
        .error-header, .warning-header {
            font-weight: 600;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
        }
        
        .error-header {
            background: #f8d7da;
            color: #721c24;
        }
        
        .warning-header {
            background: #fff3cd;
            color: #856404;
        }
        
        .error-item, .warning-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .error-item {
            background: #f8d7da;
            color: #721c24;
            border-left: 3px solid #dc3545;
        }
        
        .warning-item {
            background: #fff3cd;
            color: #856404;
            border-left: 3px solid #ffc107;
        }
        
        .download-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .download-button {
            flex: 1;
            padding: 12px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
        }
        
        .proceed-button {
            flex: 1;
            padding: 12px 20px;
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .proceed-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 193, 7, 0.3);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .summary-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Amazon Vendor Central Shipment Upload Generator</h1>
            <p>Generate shipment upload files with automated PO matching and validation</p>
        </div>
        
        <div class="main-content">
            <!-- Step 1: Warehouse Selection -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Select Warehouse</div>
                </div>
                <div class="warehouse-selection">
                    <div class="warehouse-option" onclick="selectWarehouse('UNIS')" id="unis-option">
                        <h3>UNIS</h3>
                        <p>Buena Park, CA</p>
                    </div>
                    <div class="warehouse-option" onclick="selectWarehouse('Encore')" id="encore-option">
                        <h3>Encore</h3>
                        <p>Oklahoma City, OK</p>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Pickup Date -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Set Pickup Date</div>
                </div>
                <div class="date-input-group">
                    <label for="pickup-date">Requested Pickup Date:</label>
                    <input type="date" id="pickup-date" class="date-input">
                </div>
            </div>
            
            <!-- Step 3: Upload Shipment Download -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Upload Shipment Download</div>
                </div>
                <div class="file-upload-area" id="shipment-upload" onclick="document.getElementById('shipment-file').click()">
                    <input type="file" id="shipment-file" class="file-input" accept=".xlsx,.xls">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">Shipment template from Vendor Central (.xlsx)</div>
                </div>
            </div>
            
            <!-- Step 4: Upload PO Worksheet -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Upload PO Worksheet</div>
                </div>
                <div class="file-upload-area" id="po-upload" onclick="document.getElementById('po-file').click()">
                    <input type="file" id="po-file" class="file-input" accept=".xlsx,.xls">
                    <div class="upload-icon">üìã</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">PO worksheet with accept unis/encore tabs (.xlsx)</div>
                </div>
            </div>
            
            <!-- Process Button -->
            <button class="process-button" onclick="processFiles()" disabled id="process-btn">
                Process Files
            </button>
            
            <!-- Processing Animation -->
            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p>Processing your files...</p>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">Matching POs, validating data, and generating shipments</p>
            </div>
            
            <!-- Results Section -->
            <div class="results" id="results">
                <div class="success-message" id="success-message">
                    File processed successfully!
                </div>
                
                <div class="summary-grid" id="summary"></div>
                
                <div class="error-section" id="error-section" style="display: none;">
                    <div class="error-header">‚ùå Errors Found</div>
                    <div id="error-list"></div>
                </div>
                
                <div class="warning-section" id="warning-section" style="display: none;">
                    <div class="warning-header">‚ö†Ô∏è Warnings</div>
                    <div id="warning-list"></div>
                </div>
                
                <div class="download-section">
                    <button class="download-button" onclick="downloadFile()">
                        Download Generated File
                    </button>
                    <button class="proceed-button" onclick="proceedWithErrors()" id="proceed-btn" style="display: none;">
                        Proceed Anyway
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedWarehouse = null;
        let selectedDate = null;
        let shipmentWorkbook = null;
        let poWorkbook = null;
        let outputWorkbook = null;
        let hasErrors = false;
        let processedData = null;
        
        // Warehouse selection
        function selectWarehouse(warehouse) {
            selectedWarehouse = warehouse;
            document.querySelectorAll('.warehouse-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById(`${warehouse.toLowerCase()}-option`).classList.add('selected');
            checkReadyToProcess();
        }
        
        // Date selection
        document.getElementById('pickup-date').addEventListener('change', function(e) {
            selectedDate = e.target.value;
            checkReadyToProcess();
        });
        
        // File upload handlers
        document.getElementById('shipment-file').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'shipment');
        });
        
        document.getElementById('po-file').addEventListener('change', function(e) {
            handleFileUpload(e.target.files[0], 'po');
        });
        
        // Drag and drop handlers
        ['shipment-upload', 'po-upload'].forEach(id => {
            const element = document.getElementById(id);
            
            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                element.classList.add('drag-over');
            });
            
            element.addEventListener('dragleave', () => {
                element.classList.remove('drag-over');
            });
            
            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                const type = id.includes('shipment') ? 'shipment' : 'po';
                handleFileUpload(file, type);
            });
        });
        
        function handleFileUpload(file, type) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {
                    type: 'array',
                    cellFormulas: true,
                    cellDates: true,
                    cellNF: true,
                    cellStyles: true,
                    sheetStubs: true
                });
                
                if (type === 'shipment') {
                    shipmentWorkbook = workbook;
                    updateUploadArea('shipment-upload', file.name, file.size);
                } else {
                    poWorkbook = workbook;
                    updateUploadArea('po-upload', file.name, file.size);
                }
                
                checkReadyToProcess();
            };
            reader.readAsArrayBuffer(file);
        }
        
        function updateUploadArea(areaId, fileName, fileSize) {
            const area = document.getElementById(areaId);
            area.classList.add('file-loaded');
            
            const sizeKB = (fileSize / 1024).toFixed(1);
            area.innerHTML = `
                <div class="upload-icon">‚úÖ</div>
                <div class="file-info">
                    <div>
                        <div class="file-name">${fileName}</div>
                        <div class="file-size">${sizeKB} KB</div>
                    </div>
                    <button class="remove-file" onclick="removeFile('${areaId}')">Remove</button>
                </div>
            `;
        }
        
        function removeFile(areaId) {
            const area = document.getElementById(areaId);
            area.classList.remove('file-loaded');
            
            if (areaId === 'shipment-upload') {
                shipmentWorkbook = null;
                document.getElementById('shipment-file').value = '';
                area.innerHTML = `
                    <input type="file" id="shipment-file" class="file-input" accept=".xlsx,.xls">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">Shipment template from Vendor Central (.xlsx)</div>
                `;
                document.getElementById('shipment-file').addEventListener('change', function(e) {
                    handleFileUpload(e.target.files[0], 'shipment');
                });
            } else {
                poWorkbook = null;
                document.getElementById('po-file').value = '';
                area.innerHTML = `
                    <input type="file" id="po-file" class="file-input" accept=".xlsx,.xls">
                    <div class="upload-icon">üìã</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">PO worksheet with accept unis/encore tabs (.xlsx)</div>
                `;
                document.getElementById('po-file').addEventListener('change', function(e) {
                    handleFileUpload(e.target.files[0], 'po');
                });
            }
            
            checkReadyToProcess();
        }
        
        function checkReadyToProcess() {
            const btn = document.getElementById('process-btn');
            if (selectedWarehouse && selectedDate && shipmentWorkbook && poWorkbook) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
        
        function processFiles() {
            document.getElementById('processing').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            setTimeout(() => {
                try {
                    const results = performProcessing();
                    processedData = results;
                    displayResults(results);
                } catch (error) {
                    alert('Error processing files: ' + error.message);
                    console.error(error);
                    document.getElementById('processing').style.display = 'none';
                }
            }, 100);
        }
        
        function performProcessing() {
            const errors = [];
            const warnings = [];
            const stats = {
                itemsProcessed: 0,
                rowsDeleted: 0,
                shipmentsCreated: 0,
                totalQuantity: 0,
                destinationsProcessed: new Set()
            };
            
            // Get the appropriate sheet names based on warehouse selection
            const acceptSheetName = selectedWarehouse === 'UNIS' ? 'accept unis' : 'accept encore';
            const pivotSheetName = selectedWarehouse === 'UNIS' ? 'unis pivot' : 'encore pivot';
            
            // Check if required sheets exist
            if (!poWorkbook.Sheets[acceptSheetName]) {
                errors.push(`Required sheet "${acceptSheetName}" not found in PO worksheet`);
                return { errors, warnings, stats };
            }
            
            if (!poWorkbook.Sheets[pivotSheetName]) {
                errors.push(`Required sheet "${pivotSheetName}" not found in PO worksheet`);
                return { errors, warnings, stats };
            }
            
            // Read PO data
            const poSheet = poWorkbook.Sheets[acceptSheetName];
            const poData = XLSX.utils.sheet_to_json(poSheet, {header: 1, raw: false, defval: ''});
            
            // Read pivot data
            const pivotSheet = poWorkbook.Sheets[pivotSheetName];
            const pivotData = XLSX.utils.sheet_to_json(pivotSheet, {header: 1, raw: false, defval: ''});
            
            // Create lookup maps
            const poLookup = {};
            const destinationMap = {};
            
            // Build PO lookup (po-asin is in column E, index 4)
            for (let i = 1; i < poData.length; i++) {
                const poAsin = poData[i][4]; // Column E - po-asin
                const quantity = parseFloat(poData[i][5]) || 0; // Column F - Total Qty to Fulfill
                const destination = poData[i][13]; // Column N - Fulfillment Center
                
                if (poAsin) {
                    poLookup[poAsin] = {
                        quantity: quantity,
                        destination: destination
                    };
                    
                    // Track destinations
                    if (destination && !destinationMap[destination]) {
                        destinationMap[destination] = {
                            items: [],
                            totalQty: 0
                        };
                    }
                    
                    if (destination) {
                        destinationMap[destination].items.push(poAsin);
                        destinationMap[destination].totalQty += quantity;
                    }
                }
            }
            
            // Build pivot lookup
            const pivotLookup = {};
            for (let i = 1; i < pivotData.length; i++) {
                const destination = pivotData[i][0]; // Column A - Row Labels
                if (destination && destination !== 'Grand Total') {
                    pivotLookup[destination] = {
                        cartons: Math.ceil(parseFloat(pivotData[i][2]) || 0), // Column C - Sum of CARTONS
                        weight: Math.ceil(parseFloat(pivotData[i][3]) || 0),  // Column D - Sum of WT
                        volume: Math.ceil(parseFloat(pivotData[i][4]) || 0),  // Column E - Sum of VOL
                        pallets: Math.ceil(parseFloat(pivotData[i][5]) || 0)  // Column F - Sum of PALLETS
                    };
                }
            }
            
            // Clone shipment workbook for output
            outputWorkbook = XLSX.utils.book_new();
            
            // Copy all sheets with formulas preserved
            shipmentWorkbook.SheetNames.forEach(sheetName => {
                const originalSheet = shipmentWorkbook.Sheets[sheetName];
                const range = XLSX.utils.decode_range(originalSheet['!ref']);
                const newSheet = {};
                
                // Copy all cells including formulas
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                        if (originalSheet[cellAddress]) {
                            newSheet[cellAddress] = Object.assign({}, originalSheet[cellAddress]);
                        }
                    }
                }
                
                // Copy sheet properties
                newSheet['!ref'] = originalSheet['!ref'];
                if (originalSheet['!cols']) newSheet['!cols'] = originalSheet['!cols'];
                if (originalSheet['!rows']) newSheet['!rows'] = originalSheet['!rows'];
                if (originalSheet['!merges']) newSheet['!merges'] = originalSheet['!merges'];
                
                XLSX.utils.book_append_sheet(outputWorkbook, newSheet, sheetName);
            });
            
            // Process Items to ship sheet
            const itemsSheet = outputWorkbook.Sheets['Items to ship'];
            const itemsData = XLSX.utils.sheet_to_json(itemsSheet, {header: 1, raw: false, defval: ''});
            
            // Detect number of shipment columns
            let numShipments = 0;
            const headerRow = itemsData[2]; // Row 3 has headers
            for (let col = 13; col < headerRow.length; col++) { // Start from column N
                if (headerRow[col] && headerRow[col].toString().startsWith('Shipment') && 
                    !headerRow[col].toString().includes('Window')) {
                    numShipments++;
                } else if (numShipments > 0) {
                    break; // Stop when we hit non-shipment columns
                }
            }
            
            console.log(`Detected ${numShipments} shipment columns`);
            
            // Create destination to shipment number mapping
            const destToShipment = {};
            let nextShipmentNum = 1;
            
            // Process each row
            const rowsToDelete = [];
            for (let row = 3; row < itemsData.length; row++) { // Data starts at row 4 (index 3)
                const poNumber = itemsData[row][0]; // Column A
                const asin = itemsData[row][7]; // Column H - ASIN/MSKU
                
                if (!poNumber || !asin) continue;
                
                const poAsinKey = poNumber + asin;
                
                if (poLookup[poAsinKey]) {
                    // Found in PO worksheet
                    const poInfo = poLookup[poAsinKey];
                    const destination = poInfo.destination;
                    
                    // Assign shipment number to destination if not already assigned
                    if (destination && !destToShipment[destination]) {
                        if (nextShipmentNum > numShipments) {
                            errors.push(`Need ${nextShipmentNum} shipments but template only has ${numShipments}`);
                            break;
                        }
                        destToShipment[destination] = nextShipmentNum++;
                        stats.destinationsProcessed.add(destination);
                    }
                    
                    // Check quantity match
                    const confirmedQty = parseFloat(itemsData[row][8]) || 0; // Column I - Confirmed
                    const leftToShip = parseFloat(itemsData[row][10]) || 0; // Column K - Left to ship
                    
                    if (Math.abs(confirmedQty - poInfo.quantity) > 0.01) {
                        warnings.push(`Quantity mismatch for ${poAsinKey}: Shipment has ${confirmedQty}, PO has ${poInfo.quantity}`);
                    }
                    
                    if (poInfo.quantity > leftToShip) {
                        warnings.push(`Quantity exceeds left to ship for ${poAsinKey}: ${poInfo.quantity} > ${leftToShip}`);
                    }
                    
                    // Update shipment quantity
                    if (destination && destToShipment[destination]) {
                        const shipmentCol = 13 + destToShipment[destination] - 1;
                        itemsData[row][shipmentCol] = poInfo.quantity;
                        stats.itemsProcessed++;
                        stats.totalQuantity += poInfo.quantity;
                    }
                } else {
                    // Not found in PO worksheet - mark for deletion
                    rowsToDelete.push(row);
                    errors.push(`PO/ASIN not found: ${poAsinKey}`);
                    stats.rowsDeleted++;
                }
            }
            
            // Delete rows that weren't found (process in reverse order)
            rowsToDelete.reverse().forEach(rowIndex => {
                itemsData.splice(rowIndex, 1);
            });
            
            // Convert back to sheet
            const newItemsSheet = XLSX.utils.aoa_to_sheet(itemsData);
            
            // Preserve formulas from original sheet
            const originalItemsSheet = shipmentWorkbook.Sheets['Items to ship'];
            const range = XLSX.utils.decode_range(originalItemsSheet['!ref']);
            
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    const originalCell = originalItemsSheet[cellAddress];
                    
                    if (originalCell && originalCell.f) {
                        // Preserve formula
                        if (!newItemsSheet[cellAddress]) {
                            newItemsSheet[cellAddress] = {};
                        }
                        newItemsSheet[cellAddress].f = originalCell.f;
                    }
                }
            }
            
            outputWorkbook.Sheets['Items to ship'] = newItemsSheet;
            
            // Process Shipment details sheet - DO NOT convert to array to preserve formulas
            const detailsSheet = outputWorkbook.Sheets['Shipment details'];
            const originalDetailsSheet = shipmentWorkbook.Sheets['Shipment details'];
            
            // Format pickup date for Excel
            const dateObj = new Date(selectedDate + 'T12:00:00');
            const excelDate = (dateObj - new Date(1899, 11, 30)) / (24 * 60 * 60 * 1000);
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const displayDate = `${dateObj.getDate()}-${monthNames[dateObj.getMonth()]}`;
            
            // Determine pickup location based on warehouse
            const pickupLocation = selectedWarehouse === 'UNIS' 
                ? '6800 Valley View St. Dock 18,Buena Park,CA 90620'
                : '3815 N Santa Fe Ave Dock 3,Oklahoma City,OK 73118';
            
            // Update shipment details for each destination - work directly with cells
            Object.entries(destToShipment).forEach(([destination, shipmentNum]) => {
                const col = 2 + shipmentNum - 1; // Column C is index 2
                
                // Row 5 (index 4): Requested pick up date
                const dateCell = XLSX.utils.encode_cell({r: 4, c: col});
                if (!detailsSheet[dateCell]) detailsSheet[dateCell] = {};
                detailsSheet[dateCell].t = 'n';
                detailsSheet[dateCell].v = excelDate;
                detailsSheet[dateCell].w = displayDate;
                detailsSheet[dateCell].z = 'd-mmm';
                
                // Row 6 (index 5): Pick up location
                const locationCell = XLSX.utils.encode_cell({r: 5, c: col});
                if (!detailsSheet[locationCell]) detailsSheet[locationCell] = {};
                detailsSheet[locationCell].t = 's';
                detailsSheet[locationCell].v = pickupLocation;
                
                // Row 7 (index 6): Stacked pallets (always 0)
                const stackedCell = XLSX.utils.encode_cell({r: 6, c: col});
                if (!detailsSheet[stackedCell]) detailsSheet[stackedCell] = {};
                detailsSheet[stackedCell].t = 'n';
                detailsSheet[stackedCell].v = 0;
                
                // Get logistics data from pivot
                if (pivotLookup[destination]) {
                    const logistics = pivotLookup[destination];
                    
                    // Row 8 (index 7): Unstacked pallets
                    const unstackedCell = XLSX.utils.encode_cell({r: 7, c: col});
                    if (!detailsSheet[unstackedCell]) detailsSheet[unstackedCell] = {};
                    detailsSheet[unstackedCell].t = 'n';
                    detailsSheet[unstackedCell].v = logistics.pallets;
                    
                    // Row 9 (index 8): Cartons
                    const cartonsCell = XLSX.utils.encode_cell({r: 8, c: col});
                    if (!detailsSheet[cartonsCell]) detailsSheet[cartonsCell] = {};
                    detailsSheet[cartonsCell].t = 'n';
                    detailsSheet[cartonsCell].v = logistics.cartons;
                    
                    // Row 10 (index 9): Total weight
                    const weightCell = XLSX.utils.encode_cell({r: 9, c: col});
                    if (!detailsSheet[weightCell]) detailsSheet[weightCell] = {};
                    detailsSheet[weightCell].t = 'n';
                    detailsSheet[weightCell].v = logistics.weight;
                    
                    // Row 11 (index 10): Total volume
                    const volumeCell = XLSX.utils.encode_cell({r: 10, c: col});
                    if (!detailsSheet[volumeCell]) detailsSheet[volumeCell] = {};
                    detailsSheet[volumeCell].t = 'n';
                    detailsSheet[volumeCell].v = logistics.volume;
                } else {
                    warnings.push(`No logistics data found for destination: ${destination}`);
                }
            });
            
            outputWorkbook.Sheets['Shipment details'] = detailsSheet;
            
            stats.shipmentsCreated = Object.keys(destToShipment).length;
            
            return { errors, warnings, stats };
        }
        
        function displayResults(results) {
            document.getElementById('processing').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            hasErrors = results.errors.length > 0 || results.warnings.length > 0;
            
            // Display summary
            const summaryHtml = `
                <div class="summary-item">
                    <div class="summary-value">${results.stats.itemsProcessed}</div>
                    <div class="summary-label">Items Processed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${results.stats.totalQuantity}</div>
                    <div class="summary-label">Total Units</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${results.stats.shipmentsCreated}</div>
                    <div class="summary-label">Shipments Created</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${results.stats.rowsDeleted}</div>
                    <div class="summary-label">Rows Deleted</div>
                </div>
            `;
            document.getElementById('summary').innerHTML = summaryHtml;
            
            // Display errors
            if (results.errors.length > 0) {
                document.getElementById('error-section').style.display = 'block';
                let errorHtml = '';
                
                // Group similar errors
                const poAsinErrors = results.errors.filter(e => e.includes('PO/ASIN not found'));
                const otherErrors = results.errors.filter(e => !e.includes('PO/ASIN not found'));
                
                if (poAsinErrors.length > 5) {
                    // Show first 5 and summarize
                    poAsinErrors.slice(0, 5).forEach(error => {
                        errorHtml += `<div class="error-item">${error}</div>`;
                    });
                    errorHtml += `<div class="error-item">... and ${poAsinErrors.length - 5} more PO/ASIN combinations not found</div>`;
                } else {
                    poAsinErrors.forEach(error => {
                        errorHtml += `<div class="error-item">${error}</div>`;
                    });
                }
                
                otherErrors.forEach(error => {
                    errorHtml += `<div class="error-item">${error}</div>`;
                });
                
                document.getElementById('error-list').innerHTML = errorHtml;
                document.getElementById('proceed-btn').style.display = 'inline-block';
            } else {
                document.getElementById('error-section').style.display = 'none';
                document.getElementById('proceed-btn').style.display = 'none';
            }
            
            // Display warnings
            if (results.warnings.length > 0) {
                document.getElementById('warning-section').style.display = 'block';
                let warningHtml = '';
                
                results.warnings.slice(0, 10).forEach(warning => {
                    warningHtml += `<div class="warning-item">${warning}</div>`;
                });
                
                if (results.warnings.length > 10) {
                    warningHtml += `<div class="warning-item">... and ${results.warnings.length - 10} more warnings</div>`;
                }
                
                document.getElementById('warning-list').innerHTML = warningHtml;
            } else {
                document.getElementById('warning-section').style.display = 'none';
            }
            
            // Update success message
            if (results.errors.length === 0 && results.warnings.length === 0) {
                document.getElementById('success-message').textContent = 
                    `‚úÖ File processed successfully! Created ${results.stats.shipmentsCreated} shipments for ${results.stats.destinationsProcessed.size} destinations.`;
            } else {
                document.getElementById('success-message').textContent = 
                    `‚ö†Ô∏è File processed with ${results.errors.length} errors and ${results.warnings.length} warnings.`;
            }
        }
        
        function proceedWithErrors() {
            // Hide the proceed button and update message
            document.getElementById('proceed-btn').style.display = 'none';
            document.getElementById('success-message').textContent = 
                '‚úÖ Proceeding with file generation despite errors/warnings.';
        }
        
        function downloadFile() {
            if (!outputWorkbook) {
                alert('No file to download. Please process files first.');
                return;
            }
            
            // Generate filename with current date
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const filename = `Generated Shipment Create Upload_${yyyy}.${mm}.${dd}.xlsx`;
            
            // Write the workbook
            const wbout = XLSX.write(outputWorkbook, {
                bookType: 'xlsx',
                type: 'binary',
                cellFormulas: true,
                cellDates: true,
                cellStyles: true
            });
            
            // Convert to blob
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) {
                    view[i] = s.charCodeAt(i) & 0xFF;
                }
                return buf;
            }
            
            const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Initialize date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('pickup-date').value = `${yyyy}-${mm}-${dd}`;
            selectedDate = `${yyyy}-${mm}-${dd}`;
        });
    </script>
</body>
</html>
